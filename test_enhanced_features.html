<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Enhanced Features - Categories & Reviews</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Test Enhanced Features</h1>
        
        <!-- Categories Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-blue-600">Categories Management</h2>
            
            <!-- Create Category Form -->
            <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                <h3 class="text-lg font-medium mb-3">Create New Category</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="categoryName" placeholder="Category Name" 
                           class="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="categoryDescription" placeholder="Description (optional)" 
                           class="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="createCategory()" 
                            class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        Create Category
                    </button>
                </div>
            </div>
            
            <!-- Categories List -->
            <div class="mb-4">
                <button onclick="loadCategories()" 
                        class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors mb-4">
                    Load Categories
                </button>
                <div id="categoriesList" class="space-y-2"></div>
            </div>
        </div>
        
        <!-- Reviews Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-green-600">Reviews Management</h2>
            
            <!-- Create Review Form -->
            <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                <h3 class="text-lg font-medium mb-3">Create New Review</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="number" id="reviewProductId" placeholder="Product ID" 
                           class="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <select id="reviewRating" class="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="">Select Rating</option>
                        <option value="1">1 Star</option>
                        <option value="2">2 Stars</option>
                        <option value="3">3 Stars</option>
                        <option value="4">4 Stars</option>
                        <option value="5">5 Stars</option>
                    </select>
                    <input type="text" id="reviewComment" placeholder="Review Comment" 
                           class="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button onclick="createReview()" 
                            class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                        Create Review
                    </button>
                </div>
            </div>
            
            <!-- View Reviews -->
            <div class="mb-4">
                <div class="flex gap-4 mb-4">
                    <input type="number" id="viewProductId" placeholder="Product ID" 
                           class="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button onclick="loadReviews()" 
                            class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                        Load Reviews
                    </button>
                </div>
                <div id="reviewsList" class="space-y-2"></div>
            </div>
        </div>
        
        <!-- Products with Reviews Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-4 text-purple-600">Products with Reviews</h2>
            <button onclick="loadProductsWithReviews()" 
                    class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors mb-4">
                Load Products with Reviews
            </button>
            <div id="productsWithReviews" class="space-y-4"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost/ecommerce-api';
        let authToken = localStorage.getItem('authToken');
        
        // Check if user is logged in
        if (!authToken) {
            alert('Please log in first to test these features');
            window.location.href = 'test_auth_form.html';
        }
        
        async function createCategory() {
            const name = document.getElementById('categoryName').value;
            const description = document.getElementById('categoryDescription').value;
            
            if (!name) {
                alert('Category name is required');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/categories`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ name, description })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Category created successfully!');
                    document.getElementById('categoryName').value = '';
                    document.getElementById('categoryDescription').value = '';
                    loadCategories();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/categories`);
                const result = await response.json();
                
                if (result.success) {
                    const categoriesList = document.getElementById('categoriesList');
                    categoriesList.innerHTML = result.categories.map(category => `
                        <div class="flex justify-between items-center p-3 border rounded-lg bg-gray-50">
                            <div>
                                <strong>${category.name}</strong>
                                ${category.description ? `<br><span class="text-gray-600">${category.description}</span>` : ''}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editCategory(${category.id}, '${category.name}', '${category.description || ''}')" 
                                        class="bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600">
                                    Edit
                                </button>
                                <button onclick="deleteCategory(${category.id})" 
                                        class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function editCategory(id, name, description) {
            const newName = prompt('Enter new category name:', name);
            const newDescription = prompt('Enter new description:', description);
            
            if (newName === null) return;
            
            try {
                const response = await fetch(`${API_BASE}/categories/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ name: newName, description: newDescription })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Category updated successfully!');
                    loadCategories();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function deleteCategory(id) {
            if (!confirm('Are you sure you want to delete this category?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/categories/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Category deleted successfully!');
                    loadCategories();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function createReview() {
            const productId = document.getElementById('reviewProductId').value;
            const rating = document.getElementById('reviewRating').value;
            const comment = document.getElementById('reviewComment').value;
            
            if (!productId || !rating || !comment) {
                alert('Product ID, rating, and comment are required');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/reviews`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ product_id: productId, rating, comment })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Review created successfully!');
                    document.getElementById('reviewProductId').value = '';
                    document.getElementById('reviewRating').value = '';
                    document.getElementById('reviewComment').value = '';
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function loadReviews() {
            const productId = document.getElementById('viewProductId').value;
            
            if (!productId) {
                alert('Please enter a product ID');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/reviews/${productId}`);
                const result = await response.json();
                
                if (result.success) {
                    const reviewsList = document.getElementById('reviewsList');
                    reviewsList.innerHTML = `
                        <div class="mb-4 p-3 bg-blue-50 border rounded-lg">
                            <strong>Average Rating: ${result.average_rating || 'No ratings yet'}</strong>
                        </div>
                        ${result.reviews.map(review => `
                            <div class="p-3 border rounded-lg bg-gray-50">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <strong>${review.username}</strong>
                                        <div class="text-yellow-500">
                                            ${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}
                                        </div>
                                        <p>${review.comment}</p>
                                        <small class="text-gray-500">${new Date(review.created_at).toLocaleDateString()}</small>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    `;
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function loadProductsWithReviews() {
            try {
                const response = await fetch(`${API_BASE}/products`);
                const result = await response.json();
                
                if (result.success) {
                    const productsContainer = document.getElementById('productsWithReviews');
                    productsContainer.innerHTML = result.products.map(product => `
                        <div class="border rounded-lg p-4 bg-gray-50">
                            <h3 class="text-lg font-semibold mb-2">${product.name}</h3>
                            <p class="text-gray-600 mb-2">${product.description}</p>
                            <p class="text-green-600 font-semibold">$${product.price}</p>
                            <button onclick="loadProductReviews(${product.id})" 
                                    class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                View Reviews
                            </button>
                            <div id="reviews-${product.id}" class="mt-3"></div>
                        </div>
                    `).join('');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function loadProductReviews(productId) {
            try {
                const response = await fetch(`${API_BASE}/reviews/${productId}`);
                const result = await response.json();
                
                const reviewsContainer = document.getElementById(`reviews-${productId}`);
                
                if (result.success) {
                    reviewsContainer.innerHTML = `
                        <div class="border-t pt-3">
                            <strong>Average Rating: ${result.average_rating || 'No ratings yet'}</strong>
                            ${result.reviews.map(review => `
                                <div class="mt-2 p-2 bg-white rounded border">
                                    <div class="text-yellow-500">${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}</div>
                                    <p class="text-sm">${review.comment}</p>
                                    <small class="text-gray-500">by ${review.username}</small>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    reviewsContainer.innerHTML = `<p class="text-red-500">Error: ${result.error}</p>`;
                }
            } catch (error) {
                const reviewsContainer = document.getElementById(`reviews-${productId}`);
                reviewsContainer.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            }
        }
        
        // Load categories on page load
        window.onload = function() {
            loadCategories();
        };
    </script>
</body>
</html>
